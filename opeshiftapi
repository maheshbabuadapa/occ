from flask import Flask, jsonify
import subprocess

app = Flask(__name__)

# Replace these values with your OpenShift cluster URL, username, password, and namespace
CLUSTER_URL = "https://your-openshift-cluster-url:6443"
USERNAME = "your-username"
PASSWORD = "your-password"
NAMESPACE = "your-namespace"

def login_to_cluster():
    login_cmd = ["oc", "login", CLUSTER_URL, "-u", USERNAME, "-p", PASSWORD, "--insecure-skip-tls-verify=true"]
    result = subprocess.run(login_cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    if result.returncode != 0:
        print(f"Login failed: {result.stderr}")
    else:
        print("Login successful")

def get_deployment_images():
    login_to_cluster()
    cmd = [
        "oc", "get", "deployments", "-n", NAMESPACE, "-o",
        "jsonpath={range .items[*]}{range .spec.template.spec.containers[*]}{.image}{\"\\n\"}{end}{end}"
    ]
    result = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)

    images = []
    if result.returncode == 0:
        images = list(set(result.stdout.strip().split('\n')))
    else:
        print(f"Error executing command: {result.stderr}")

    return images

@app.route('/')
def index():
    images = get_deployment_images()
    return jsonify(images)

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
